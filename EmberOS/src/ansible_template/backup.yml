---
- name: Pull backup from all servers
  
  hosts: emberos
  remote_user: pi

  tasks:
  - name: Create local directory
    ansible.builtin.file:
      path: machines/{{ansible_hostname}}/sketch/
      state: directory
    register: local_dir
    delegate_to: localhost

  - name: Create local directory
    ansible.builtin.file:
      path: machines/{{ansible_hostname}}/boot/
      state: directory
    register: local_dir
    delegate_to: localhost


  - name: Pull the backup of /boot
    synchronize:
      src: /boot/
      dest: machines/{{ansible_hostname}}/boot/
      checksum: yes
      mode: pull
      become: yes
      #Things that presumably *could* be wanted
      #See the top 2 lines if you want to not back up the networks.
      rsync_opts:
        #- "--exclude=networks/**"
        - "--include=*.nmconnection"
        - "--include=*.ini"
        - "--include=*.yaml"
        - "--include=*.txt"
        - "--include=*.xml"
        - "--include=*.conf"
        - "--include=*.png"
        - "--include=*.jpg"
        - "--include=*.py"
        - "--include=*.sh"
        - "--exclude=*"

  - name: Pull the backup of /sketch
    synchronize:
      src: /sketch/
      dest: machines/{{ansible_hostname}}/sketch/
      checksum: yes
      mode: pull
      become: yes
      #Things that presumably *could* be wanted
      rsync_opts:
        - "--exclude-from=ignore.txt"