#!/bin/bash

set -x
set -e

source /common.sh

mkdir -p /sketch/kaithem/


#Suck tastic way to do this, it redownloads every time. I hate it but it it simple and reliable.
#Eventually we will make build cache persistent
git clone --depth 1 https://github.com/EternityForest/KaithemAutomation.git /build_cache/KaithemAutomation


git clone --depth 1 /build_cache/KaithemAutomation /opt/kaithem

git remote remove origin
git remote add origin https://github.com/EternityForest/KaithemAutomation
git branch --set-upstream-to=origin/master master

rsync -avz /opt/kaithem/kaithem/var/  /sketch/kaithem/

unpack /filesystem/kaithem_sketch/ /sketch/kaithem/ root

unpack /filesystem/systemd/ /usr/lib/systemd/system/ root

#Remove dummy keys so the user can add them if missing
! rm /sketch/kaithem/ssl/certificate.key
! rm /sketch/kaithem/ssl/certificate.cert

chmod a+x /opt/kaithem/ /opt/kaithem/kaithem/kaithem.py
