#!/bin/bash

set -x
set -e

apt -y install mosquitto
systemctl enable mosquitto



#Also gets firewalld
# apt -y install firewall-config

#Batteries included, allow messing with kiosk browser media right from the device
apt -y install gimp audacity tuxpaint
apt -y install transmission-cli 
apt -y install xclip zenmap

apt -y install sqlitebrowser

#Always good to have around
apt -y install gnome-disk-utility

apt -y install unclutter


apt -y install fvwm fvwm-icons


# Installs the Micro editor
# Do this early, it can't be cached like apt
cd /usr/bin/
curl https://getmic.ro | bash

#Useful for testing
apt -y install x11-apps



#Update timezones
apt -y install tzdata

#Pre populate sketch
mkdir -p /sketch/timezones
cp -a /usr/share/zoneinfo/. /sketch/timezones


apt -y install exfat-utils
apt -y install python3-setproctitle

pip3 install yappi






mkdir -p /home/pi/.fvwm/

cat << EOF > /home/pi/.fvwm/.FvwmForm-XDGMenu-Config 
*FvwmForm-XDGMenu-ConfigDefault: MENdebian-menu off 
*FvwmForm-XDGMenu-ConfigDefault: MENgnome-applications off
*FvwmForm-XDGMenu-ConfigDefault: MENlxde-pi-applications on 
*FvwmForm-XDGMenu-ConfigDefault: MENxfce-applications off
*FvwmForm-XDGMenu-ConfigDefault: MENxfce-settings-manager off 
*FvwmForm-XDGMenu-ConfigDefault: MENlxde-applications on 
*FvwmForm-XDGMenu-ConfigDefault: IncludeConfig  
*FvwmForm-XDGMenu-ConfigDefault: IncludeRegen  
*FvwmForm-XDGMenu-ConfigDefault: IncludeBoth  on 
*FvwmForm-XDGMenu-ConfigDefault: IncludeNone   
*FvwmForm-XDGMenu-ConfigDefault: IconsOn      on 
*FvwmForm-XDGMenu-ConfigDefault: IconsOff      
*FvwmForm-XDGMenu-ConfigDefault: Size          
*FvwmForm-XDGMenu-ConfigDefault: TitlesOn     on 
*FvwmForm-XDGMenu-ConfigDefault: TitlesOff     
*FvwmForm-XDGMenu-ConfigDefault: Theme         
*FvwmForm-XDGMenu-ConfigDefault: Title        XDGMenu  
*FvwmForm-XDGMenu-ConfigDefault: InsertInto    
*FvwmForm-XDGMenu-ConfigDefault: Path         $FVWM_USERDIR/.XDGMenu  
*FvwmForm-XDGMenu-ConfigDefault: TermCmd      xterm -e  
*FvwmForm-XDGMenu-ConfigDefault: IconDir      ~/.fvwm/icons  
*FvwmForm-XDGMenu-ConfigDefault: DirIcon      gnome-fs-directory  
*FvwmForm-XDGMenu-ConfigDefault: AppIcon      gnome-applications  
EOF

chown pi /home/pi/.fvwm/.FvwmForm-XDGMenu-Config



mkdir -p /publictemp
mkdir -p /sketch/public.www/
mkdir -p /sketch/public.files/

echo "Welcome! This file is /sketch/public.www/index.html"> /sketch/public.www/index.html

apt -y install apache2

#Add the user for apache to the root group.
#Do the same for apache
#TODO a solution that has less trust on it.
! adduser www-data root

sudo apt-get install -y php-{bcmath,bz2,intl,gd,mbstring,mcrypt,mysql,zip}
apt-get install libapache2-mod-php -y
sudo systemctl enable apache2.service

apt -y install mpv
apt -y install python3 systemd cython3 build-essential
apt -y install mplayer python3-serial


apt -y install pulseaudio
sudo adduser root pulse-access
sudo adduser pi pulse-access

apt -y install python3-tz python3-dateutil lm-sensors
apt -y install python3-netifaces python3-jack-client
apt -y install python3-gst-1.0 python3-libnacl jack-tools
apt -y install jackd2 gstreamer1.0-plugins-good gstreamer1.0-plugins-bad a2jmidid
apt -y install swh-plugins tap-plugins caps  gstreamer1.0-plugins-ugly python3-psutil
#Don't include a giant soundfont, kaithem already has a decent one
apt install -y --no-install-recommends  fluidsynth

apt -y install nmap robotfindskitten
apt -y install ncdu
apt -y install mc
apt -y install curl
apt -y install vim
apt -y install xcas
apt -y install units
apt -y install git
apt -y install wget
apt -y install htop
apt -y install lsof
apt -y install fzf
apt -y install chafa
apt -y install nast



#Without this we have all kinds of issues doing startx
apt -y install xserver-xorg-legacy

#Allow non-console startx, needed to make kiosk browsing work
#This has to be AFTER the xserver-xorg-legacy to work
sed -i \
    's/allowed_users=console/allowed_users=anybody/' /etc/X11/Xwrapper.config

apt -y install fatrace


#Install last so the build doesn't try using it from inside quemu
#And slow everything down by not working
apt -y install squid-deb-proxy-client



apt -y autoremove