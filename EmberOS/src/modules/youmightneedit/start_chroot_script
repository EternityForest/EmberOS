#!/bin/bash
apt update --allow-releaseinfo-change
apt update

apt -y install unclutter
apt -y install avahi-daemon 
apt -y install chrony

apt -y install avahi-utils

# Installs the Micro editor
# Do this early, it can't be cached like apt
cd /usr/bin/
curl https://getmic.ro | bash

#Useful for testing
apt install x11-apps

apt -y install exfat-utils
apt -y install samba samba-common-bin smbclient cifs-utils
apt -y install minidlna

#This is a public samba share. It's read only.
cat << EOF >> /etc/samba/smb.conf
[guest]
        # This share allows anonymous (guest) access
        # without authentication!
        path = /sketch/public.files
        read only = yes
        guest ok = yes
[media]
        # This share allows anonymous (guest) access
        # without authentication!
        path = /sketch/public.media
        read only = yes
        guest ok = yes
EOF

mkdir -p /sketch_template/public.www/
mkdir -p /sketch_template/public.files/

#This seems to be fairly low resource usage and thus safe to include
echo "media_dir=/sketch/public.media/" >> /etc/minidlna.conf
mkdir -p /sketch_template/public.media/

#Add the user for minidlna to the root group.
#TODO a solution that has less trust on it.
! adduser minidlna root

! sudo systemctl enable minidlna.service
! sudo systemctl enable smbd.service 
! sudo systemctl enable nmbd.service
apt -y install apache2

sudo apt-get install -y php-{bcmath,bz2,intl,gd,mbstring,mcrypt,mysql,zip}
apt-get install libapache2-mod-php -y
sudo systemctl enable apache2.service

apt -y install mpv
apt -y install python3 systemd cython3 build-essential
apt -y install mplayer pulseaudio python3-serial
apt -y install python3-tz python3-dateutil lm-sensors
apt -y install python3-netifaces python3-jack-client
apt -y install python3-gst-1.0 python3-libnacl jack-tools
apt -y install jackd2 gstreamer1.0-plugins-good gstreamer1.0-plugins-bad a2jmidid
apt -y install swh-plugins tap-plugins caps  gstreamer1.0-plugins-ugly python3-psutil
#Don't include a giant soundfont, kaithem already has a decent one
apt install -y --no-install-recommends  fluidsynth
apt -y install network-manager

apt -y install nmap robotfindskitten
apt -y install ncdu
apt -y install mc
apt -y install curl
apt -y install vim
apt -y install xcas
apt -y install units
apt -y install ufw
apt -y install git
apt -y install wget
apt -y install htop
apt -y install lsof
apt -y install fzf
apt -y install chafa
apt -y install nast
apt -y install xserver-xorg-legacy

apt -y install fatrace


#Install last so the build doesn't try using it from inside quemu
#And slow everything down by not working
apt -y install squid-deb-proxy-client

! ufw disable

