#!/bin/bash

set -x
set -e



#Things with manual prompts should happen early and close together
#Sadly this has a manual prompt
apt-get -y install -y wireshark
#Also sometimes SMB does too
apt-get -y install smbclient samba samba-common-bin cifs-utils minidlna



apt-get -y install mosquitto libpng16-16 chromium-browser rpi-chromium-mods
echo "persistence false" > /etc/mosquitto/conf.d/emberos.conf

# SyncThing is installed, but not set up!!!
wget -O - https://syncthing.net/release-key.txt > /etc/apt/trusted.gpg.d/syncthing.asc
echo "deb http://apt.syncthing.net/ syncthing release" | sudo tee -a /etc/apt/sources.list.d/syncthing-release.list
sudo apt-get update
sudo apt-get install syncthing syncthing-gtk -y

mkdir -p /sketch/home/pi/.syncthing
mkdir -p /sketch/home/pi/.syncthing-gtk

#We don't know if the sycthing dir will exist as soon as it's installe
! cp -ar /home/pi/.config/syncthing/. /sketch/home/pi/.syncthing
! cp -ar /home/pi/.config/syncthing-gtk/. /sketch/home/pi/.syncthing-gtk

cat << EOF > /sketch/config/filesystem/emberos_pi_syncthing.yaml
/sketch/home/pi/.syncthing:
    mode: '0700'
    user: pi
    bindat: /home/pi/.config/syncthing/
EOF

#Also gets firewalld
# apt-get -y install firewall-config


apt-get -y install dosbox

mkdir -p /sketch/home/pi/.dosbox
! cp -ar /home/pi/.dosbox/. /sketch/home/pi/.dosbox
! rm -r  /home/pi/.dosbox
ln -s /home/pi/persist/.dosbox /home/pi/.dosbox


#Batteries included, allow messing with kiosk browser media right from the device
apt-get -y install gimp audacity lame gnome-disk-utility unclutter imagemagick p7zip p7zip-full


apt-get -y install transmission-cli xclip zenmap sqlitebrowser meld git-cola audacious audacious-plugins gwenview

apt-get -y install fvwm fvwm-icons mpv libgdk-pixbuf2.0-bin

update-icon-caches /usr/share/icons/*



#Try to fix missing icons
sudo ln -s /usr/lib/*/gdk-pixbuf-2.0/gdk-pixbuf-query-loaders /usr/local/bin/gdk-pixbuf-query-loaders
gdk-pixbuf-query-loaders > /usr/lib/arm-linux-gnueabihf/gdk-pixbuf-2.0/2.10.0/loaders.cache

# Installs the Micro editor
# Do this early, it can't be cached like apt
cd /usr/bin/
curl https://getmic.ro | bash

#Useful for testing
apt-get -y install x11-apps

apt-get -y install python3

apt-get -y install exfat-utils python3-setproctitle python3-cffi python3-dbus python3-scipy python3-numpy python3-sympy python3-smbus

#This language is included because of it's excellent dynamic imports in python
#Elixir is included because it seems to be the one most practical functional type things
#Gforth is small and popular(For some reason)
#Lua is even smaller and more popular
apt-get -y install nim elixir gforth lua5.3


pip3 install yappi
pip3 install msgpack
pip3 install paho-mqtt
pip3 install smbus
pip3 install automationhat

pip3 install cherrypy
pip3 install adafruit-blinka

pip3 install nimport

pip install python-can



mkdir -p /publictemp
mkdir -p /sketch/public.www/
mkdir -p /sketch/public.files/

echo "Welcome! This file is /sketch/public.www/index.html. You can alt+f4 out to a graphical desktop."> /sketch/public.www/index.html

apt-get -y install apache2

mkdir -p /sketch/public.www

#Give www-data a "window into the root filesystem"
cat << EOF > /sketch/config/filesystem/www.yaml
/sketch/public.www:
    mode: '0750'
    user:  www-data
    bindat: /var/www/html
EOF

sudo apt-get install -y php-{bcmath,bz2,intl,gd,mbstring,mcrypt,mysql,zip}
apt-get install libapache2-mod-php -y


#All the compilerie you might want
apt-get -y install python3-dev build-essential gcc g++ cmake


apt-get -y install python3 systemd cython3 build-essential mplayer python3-serial
apt-get -y install python3-pyqt5 python3-pyqt5.qtserialport python3-pyqt5.qtsvg python3-pyqt5.qtchart python3-pyqt5.qtmultimedia
apt-get -y install python3-pyqt5.qtsql python3-pyqt5.qtwebkit python3-pyqt5.qtopengl python3-pyqt5.qtsensors
apt-get -y install python3-tz python3-dateutil lm-sensors python3-lxml
apt-get -y install python3-netifaces python3-jack-client python3-gst-1.0 python3-libnacl jack-tools
apt-get -y install jackd2 gstreamer1.0-plugins-good gstreamer1.0-plugins-bad a2jmidid
apt-get -y install swh-plugins tap-plugins caps  gstreamer1.0-plugins-ugly python3-psutil
apt-get -y install -y fluidsynth

#Better shells
apt-get -y install -y elvish fish

apt-get -y install npm
npm install -g --unsafe-perm node-red

#Coding font
apt-get -y install -y fonts-hack



apt-get -y install -y spacefm fslint deluge ardour pulseview
#Make dir persistent
mkdir -p /sketch/home/pi/.config/deluge
! cp -ar /home/pi/.config/deluge/. /sketch/home/pi/.config/deluge
! rm -r  /home/pi/.config/deluge
ln -s /home/pi/persist/.config/deluge /home/pi/.config/deluge


mkdir -p /sketch/home/pi/.config/ardour5
! cp -ar /home/pi/.config/ardour5/. /sketch/home/pi/.config/ardour5
! rm -r  /home/pi/.config/ardour5
ln -s /home/pi/persist/.config/ardour5 /home/pi/.config/ardour5

#apt-get -y install -y krita




apt-get -y install nmap robotfindskitten ncdu mc curl fatrace

#Sigh. Vim is huge but some people really love it...
apt-get -y install vim zile xcas units git wget htop lsof fzf chafa nast



#Without this we have all kinds of issues doing startx
apt-get -y install xserver-xorg-legacy

#Allow non-console startx, needed to make kiosk browsing work
#This has to be AFTER the xserver-xorg-legacy to work
sed -i \
    's/allowed_users=console/allowed_users=anybody/' /etc/X11/Xwrapper.config


gtk-update-icon-cache


#Install last so the build doesn't try using it from inside quemu
#And slow everything down by not working
#Currently removed
#apt-get -y install squid-deb-proxy-client



apt-get autoremove -y --purge
