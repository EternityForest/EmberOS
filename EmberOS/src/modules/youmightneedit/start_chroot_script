#!/bin/bash
source /common.sh

set -x
set -e



#I don't think this makes a difference, we provide our own samba conf
echo "samba-common samba-common/dhcp boolean true" | sudo debconf-set-selections
echo "samba-common samba-common/do_debconf boolean true" | sudo debconf-set-selections

#Non-superusers can't capture packets
echo "wireshark-common wireshark-common/install-setuid boolean false" | sudo debconf-set-selections

# mkdir -p /opt/ipfs-installer
# cp -ar /filesystem/ipfs-rpi/. /opt/ipfs-installer
# cd /opt/ipfs-installer
# sudo -u pi ./install
# #Give user a way to update
# ln -s /opt/ipfs-installer/ipfs-rpi-0.1.1/install /usr/bin/install-ipfs-rpi
# sudo systemctl disable ipfs-daemon.service


apt-get -y install -y wireshark

apt-get -y install smbclient samba samba-common-bin cifs-utils minidlna

unpack /filesystem/bin /usr/bin/ root
chmod 755 /usr/bin/wikioffline


cat << EOF > /etc/systemd/system/zimserver.service
[Unit]
Description=Serve wikis
After=systemd-remount-fs.service network-online.target
RequiresMountsFor=/etc/ /sketch/ /home/

[Service]
Type=simple
ExecStart=wikioffline %i
User=pi
WorkingDirectory=~


[Install]
WantedBy=sysinit.target
EOF



apt-get -y install mosquitto libpng16-16 chromium-browser rpi-chromium-mods batmand batctl 
echo "persistence false" > /etc/mosquitto/conf.d/emberos.conf

systemctl disable mosquitto.service

# SyncThing is installed, but not set up!!!
wget -O - https://syncthing.net/release-key.txt > /etc/apt/trusted.gpg.d/syncthing.asc
echo "deb http://apt.syncthing.net/ syncthing release" | sudo tee -a /etc/apt/sources.list.d/syncthing-release.list


#Retroshare
#wget -qO - http://download.opensuse.org/repositories/network:retroshare/Raspbian_9.0/Release.key | sudo apt-key add -
sudo cp /filesystem/retroshare.pubkey /etc/apt/trusted.gpg.d/retroshare.asc
echo 'deb http://download.opensuse.org/repositories/network:/retroshare/Raspbian_9.0/ /' > /etc/apt/sources.list.d/retroshare.list

#Something seems to break when we ubgrade curl and libcurl,
#so do it explicitly here, right before and update to hopefully fix that.
apt-get install curl libcurl4

sudo apt-get update
sudo apt-get install syncthing syncthing-gtk retroshare -y

mkdir -p /sketch/home/pi/.syncthing
mkdir -p /sketch/home/pi/.syncthing-gtk

#We don't know if the sycthing dir will exist as soon as it's installe
! cp -ar /home/pi/.config/syncthing/. /sketch/home/pi/.syncthing
! cp -ar /home/pi/.config/syncthing-gtk/. /sketch/home/pi/.syncthing-gtk

cat << EOF > /usr/bin/get-youtube-dl
#!/bin/bash
#This CD trick lets us avoid an unneccessary download
cd /sketch/bin/
wget -N -S --backups=1 https://yt-dl.org/downloads/latest/youtube-dl
chmod 755 youtube-dl
EOF
chmod 755 /usr/bin/get-youtube-dl


##This is currently not included, it has some challenges getting install to work
#Add the YT client
# cd /filesystem/tartube
# python3 setup.py install

# #Hack-around for something setup.py should have beed doing for us
# mkdir -p /usr/share/tartube/icons
# cp -ar icons/. /usr/share/tartube/icons

#Also gets firewalld
# apt-get -y install firewall-config



#Batteries included, allow messing with kiosk browser media right from the device
apt-get -y install gimp audacity lame gnome-disk-utility unclutter imagemagick p7zip p7zip-full testdisk baobab qsynth vmpk flite


#Ham radio stuff
apt-get -y install fldigi flrig flmsg flamp xastir chirp cubicsdr antennavis


apt-get -y install transmission-cli xclip zenmap sqlitebrowser meld git-cola audacious audacious-plugins gwenview calibre zeal convertall bluetooth bluez blueman

apt-get -y install mpv libgdk-pixbuf2.0-bin gpsd gpsd-clients marble-qt marble-maps marble-plugins dosbox wxhexeditor d-feet sshpass jami jami-daemon lirc

systemctl disable lircd.service

systemctl disable gpsd.service

# Installs the Micro editor
# Do this early, it can't be cached like apt
cd /usr/bin/
curl https://getmic.ro | bash

#Ghostwriter is used for markdown help text
apt-get -y install x11-apps xterm retext
#Try to fix missing icons
sudo ln -s /usr/lib/*/gdk-pixbuf-2.0/gdk-pixbuf-query-loaders /usr/local/bin/gdk-pixbuf-query-loaders
gdk-pixbuf-query-loaders > /usr/lib/arm-linux-gnueabihf/gdk-pixbuf-2.0/2.10.0/loaders.cache

update-icon-caches /usr/share/icons/*

apt-get -y install python3 synaptic conky-all grsync screengrab shared-mime-info rdiff-backup pocketsphinx jack-stdio

apt-get -y install exfat-utils python3-setproctitle python3-cffi python3-dbus python3-scipy python3-numpy python3-sympy python3-smbus python3-pyaudio python3-pexpect python3-pydub

#This language is included because of it's excellent dynamic imports in python
#Elixir is included because it seems to be the one most practical functional type things
#Gforth is small and popular(For some reason)
#Lua is even smaller and more popular
apt-get -y install nim elixir gforth lua5.3


# tflite tensorflow
pip3 install 	https://dl.google.com/coral/python/tflite_runtime-2.1.0.post1-cp37-cp37m-linux_armv7l.whl

pip3 install baresipy
pip3 install yappi
pip3 install automationhat

pip3 install cherrypy
pip3 install adafruit-blinka

pip3 install nimporter
pip3 install pyfirmata
pip3 install python-can

sudo apt-get -y install python3-smbus python3-msgpack python3-paho-mqtt python3-gevent python3-falcon python3-mako python3-typeguard

pip3 install zimply
pip3 install pycryptodome



mkdir -p /sketch/share/tilestache_cache

#TODO: It really sucks that you can't actually download maps automatically
cat << EOF > /sketch/config/tilestache.cfg
{
  "cache": {
      "name": "Disk",
      "path": "/home/pi/.local/share/marble/maps/earth",
      "dirs": "portable",
      "gzip": []
    },
  "layers":
  {
    "openstreetmap":
    {
      "provider":
      {
        "name": "proxy", 
        "url": "https://tile.openstreetmap.org.dummydomain/{Z}/{X}/{Y}.png"
      }
    }
  }
}
EOF

cat << EOF > /etc/systemd/system/tilestache.service
[Unit]
Description=Serve map tiles. Format is tilestache@port.service
After=systemd-remount-fs.service network-online.target
RequiresMountsFor=/etc/ /sketch/

[Service]
Type=simple
ExecStart=tilestache-server.py -p %i -c /etc/sketchconfig/tilestache.cfg
User=pi

[Install]
WantedBy=sysinit.target
EOF



apt-get -y install postgresql libpq-dev postgresql-client postgresql-contrib postgresql-client-common tilestache
mkdir -p /sketch/postgresql
mkdir -p /sketch/config/postgresql
mkdir -p /var/lib/postgresql
# systemctl start postgresql.service
# psql -c "CREATE USER www-data;"
# psql -c "CREATE DATABASE nextcloud;"
# psql -c "GRANT ALL PRIVILEGES ON DATABASE nextcloud to www-data;"
# systemctl stop postgresql.service

systemctl disable postgresql.service

cp -ar /var/lib/postgresql/. /sketch/postgresql
cp -ar /etc/postgresql/. /sketch/config/postgresql

cat << EOF > /sketch/config/filesystem/postgres.yaml
/sketch/postgresql:
    mode: '0750'
    user:  postgres
    bindat: /var/lib/postgresql

/sketch/config:
    bindfiles:
        /sketch/config/postgresql: /etc/postgresql

EOF


apt-get install -y php-{bcmath,bz2,intl,gd,mbstring,mcrypt,pgsql,zip,xml,gd,sqlite3,json}
apt-get install libapache2-mod-php -y


#All the compilerie you might want
apt-get -y install python3-dev build-essential gcc g++ cmake


apt-get -y install python3 systemd cython3 build-essential mplayer python3-serial cutecom neofetch xoscope sigrok-firmware-fx2lafw 
apt-get -y install python3-pyqt5 python3-pyqt5.qtserialport python3-pyqt5.qtsvg python3-pyqt5.qtchart python3-pyqt5.qtmultimedia
apt-get -y install python3-pyqt5.qtsql python3-pyqt5.qtwebkit python3-pyqt5.qtopengl python3-pyqt5.qtsensors
apt-get -y install python3-tz python3-dateutil lm-sensors python3-lxml python3-six python3-requests avahi-discover

apt-get -y install python3-netifaces python3-jack-client python3-gst-1.0 python3-libnacl jack-tools
apt-get -y install jackd2 gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-pocketsphinx pocketsphinx pocketsphinx-en-us a2jmidid 
apt-get -y install swh-plugins tap-plugins caps  gstreamer1.0-plugins-ugly python3-psutil mumble-server mumble
apt-get -y install -y fluidsynth pulseaudio-module-jack pulseaudio-module-bluetooth pulseaudio-module-zeroconf pulsemixer ffmpeg
apt-get -y install kodi kodi-pvr-mythtv jaaa qjackctl backintime-qt4 baresip twinkle

! adduser pi pulse-access

! systemctl disable kodi.service

! mv /etc/mumble-server.ini /sketch/config/mumble-server.ini
ln -s /etc/sketchconfig/mumble-server.ini /etc/mumble-server.ini
sudo systemctl disable mumble-server.service



apt-get -y install npm
npm install -g --unsafe-perm node-red

#Coding font
apt-get -y install -y fonts-hack



apt-get -y install -y spacefm fslint deluge ardour pulseview chkservice matchbox-keyboard

#apt-get -y install -y krita




apt-get -y install nmap robotfindskitten ncdu mc curl fatrace gstreamer1.0-tools pavucontrol xawtv evince stegosuite

apt-get -y remove qpdfview
#Sigh. Vim is huge but some people really love it...
apt-get -y install vim zile xcas units git wget htop lsof fzf chafa nast git-lfs git-repair xloadimage goldendict goldendict-wordnet pidgin

#Enable builtin wordnet, disable the wiktionary service by default because that uses
#Network
! rm /home/pi/.goldendict/config
cp /filesystem/goldendict_config /sketch/home/pi/.goldendict/config


gtk-update-icon-cache





apt-get autoremove -y --purge
