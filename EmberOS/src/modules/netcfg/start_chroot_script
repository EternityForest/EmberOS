#!/bin/bash

# Source error handling, leave this in place
set -x
set -e


source /common.sh

export LD_LIBRARY_PATH=${LD_LIBRARY_PATH:+"$LD_LIBRARY_PATH:"}/usr/lib/libeatmydata
export LD_PRELOAD=${LD_PRELOAD:+"$LD_PRELOAD "}libeatmydata.so


#Mesh neetworking!!!
sudo apt-get -y install dirmngr
#gpg --fetch-keys https://neilalexander.s3.dualstack.eu-west-2.amazonaws.com/deb/key.txt
#gpg --export 569130E8CA20FBC4CB3FDE555898470A764B32C9 | sudo apt-key add -
sudo cp /filesystem/569130E8CA20FBC4CB3FDE555898470A764B32C9.pubkey /etc/apt/trusted.gpg.d/yggdrasil.gpg
echo 'deb http://neilalexander.s3.dualstack.eu-west-2.amazonaws.com/deb/ debian yggdrasil' | sudo tee /etc/apt/sources.list.d/yggdrasil.list

sudo apt-get -y update



# Don't even think about setting this up without
# some serious firewalling(See below, but we still should probably not enable this by default for various reasons)
! systemctl disable yggdrasil

echo "Dummy file, only used as mountpoint" > /etc/yggdrasil.conf
chmod 700 /etc/yggdrasil.conf

#Manually do everything to avoind the postinst script
groupadd --system --force yggdrasil 
#Install after the dummy file, not before
cd /tmp
apt-get download yggdrasil
sudo dpkg --unpack yggdrasil*.deb
sudo rm /var/lib/dpkg/info/yggdrasil.postinst -f
sudo dpkg --configure yggdrasil
sudo apt-get install -yf #To fix dependencies

mkdir -p /boot/networks/
cp /filesystem/networks/wifi /boot/networks/boot_dir_wifi

#This will let u set up networks from /boot as well as /sketch
cat << 'EOF' > /bin/ember-copy-boot-net.sh
#!/bin/bash

mkdir -p /run/NetworkManager/system-connections/
rsync /boot/networks/ /run/NetworkManager/system-connections/
EOF

chmod 755 /bin/ember-copy-boot-net.sh

cat << EOF > /etc/systemd/system/ember-copy-boot-net.service
[Unit]
Description=Manage things from sketch folder
After=systemd-remount-fs.service
Before=NetworkManager.service
RequiresMountsFor=/sketch/ /boot/

[Service]
Type=oneshot
ExecStart=/bin/ember-copy-boot-net.sh

[Install]
WantedBy=sysinit.target

EOF
systemctl enable ember-copy-boot-net.service



apt-get -y install network-manager libnss3-tools ca-certificates nftables firewalld avahi-daemon avahi-utils radvd

systemctl enable NetworkManager.service
unpack /filesystem/networkmanager /etc/NetworkManager root



unpack /filesystem/systemd /etc/systemd/system root
unpack /filesystem/bin /usr/bin root



mkdir -p /etc/pki/nssdb








mkdir -p /var/lib/blueman



####################### Setup the firewall ##################################
unpack /filesystem/firewalld /etc/firewalld/ root


mkdir -p  /sketch/config/firewalld/

systemctl enable firewalld.service


#Yggdrasil and cjdns get firewalled to public
#SSH gets blocked from public, we don't want any hacking
mkdir -p /etc/firewalld/zones/
cat << EOF > /etc/firewalld/zones/public.xml
<?xml version="1.0" encoding="utf-8"?>
<zone target="%%REJECT%%">
  <short>Public</short>
  <description>For use in public areas. You do not trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.</description>
  <source address="300::/8"/>
  <source address="200::/8"/>
  <source address="fc00::/8"/>
  <service name="dhcpv6-client"/>
  <port port="123" protocol="udp"/>
</zone>
EOF



# Try to fix the kinds of bugs that are fixable by an Avahi restart
# https://bugs.launchpad.net/ubuntu/+source/avahi/+bug/624043
chmod 755 /usr/bin/restart_avahi.sh
chmod 744 /etc/systemd/system/restart_avahi.service
systemctl enable /etc/systemd/system/restart_avahi.service




unpack /filesystem/avahi /etc/avahi/ root




# Which one? Both? Seems to work!
! systemctl disable dhcpcd.service
! systemctl disable dhcpcd5.service

mkdir -p /etc/NetworkManager/networks
unpack /filesystem/networks /sketch/etc/NetworkManager/system-connections/ root


